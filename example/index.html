<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            background-color: rgb(45, 45, 92);
        }
    </style>
    <title>Document</title>
</head>

<body>

    <canvas id="avatar" width="250" height="250"></canvas>
    <input type="range" value="1" id="scaleSlider">
    <input type="file" id="imageFile">

    <button id="change">change</button>
    <button id="save">save</button>
    <img src="" id="newImage" name="avatarimg">

    <div>
        <canvas id="source"></canvas>
    </div>

    <script type="module">
        import Avatar from "/dist/avatar.js"

        let avatar = new Avatar('avatar', {
            // slider: { id: "scaleSlider", max: 5, },
            slider: "scaleSlider",
            // clip: "circle",
            // file: 'imageFile',  
            clip: "circle",
            image: 'images/one.jpg',
            // scroll: false max="5" 
        })
        avatar.slider({ disabled: false })

        const canvas = document.getElementById("source")
        const context = canvas.getContext("2d")

        let image = new Image()

        let mouse = { x: 0, y: 0 }
        let origin = { x: 0, y: 0 }
        let scale = 1

        let newImage = document.getElementById("newImage")

        document.getElementById("change").addEventListener("click", (e) => {
            avatar.fileSelect()
        })

        document.getElementById("save").addEventListener("click", (e) => {
            newImage.src = avatar.toPNG()
            avatar.toBlob(function (blob) {
                console.log(blob)
            })
        })

        document.getElementById("avatar").addEventListener("click", (e) => {
            console.log(origin)
            console.log(mouse)
            let hx = (origin.x + mouse.x) / 2
            let hy = (origin.y + mouse.y) / 2
            // console.log(hx, hy)
        })

        window.addEventListener("avatar-imagechanged", (e) => {
            image.src = e.detail.image
            console.log(e.detail.image)
        })

        window.addEventListener("avatar-scaled", e => {
            origin = e.detail.origin
            drawImage()
        })
        window.addEventListener("avatar-mousemove", (e) => {
            mouse = e.detail.image
            origin = e.detail.origin
            drawImage()
        })

        image.addEventListener("load", function () {
            canvas.width = image.width
            canvas.height = image.height
            scale = avatar.getScale()
            drawImage()
        })

        function drawImage() {

            let dx = origin.x - mouse.x
            let dy = origin.y - mouse.y
            let length = Math.sqrt(dx * dx + dy * dy)
            let nx = dx / length
            let ny = dy / length

            let hx = origin.x - nx * (length / 5)
            let hy = origin.y - ny * (length / 5)

            let rect = avatar.getViewRect()

            context.clearRect(0, 0, canvas.width, canvas.height)
            context.drawImage(image, 0, 0, image.width, image.height)

            context.beginPath()
            context.moveTo(origin.x, origin.y)
            context.lineTo(mouse.x, mouse.y)
            context.stroke()

            context.beginPath();
            context.arc(mouse.x, mouse.y, 4, 0, 2 * Math.PI, false);
            context.fillStyle = 'red';
            context.fill();

            context.beginPath();
            context.arc(origin.x, origin.y, 4, 0, 2 * Math.PI, false);
            context.fillStyle = 'blue';
            context.fill();

            context.beginPath();
            context.arc(hx, hy, 4, 0, 2 * Math.PI, false);
            context.fillStyle = 'green';
            context.fill();

            context.beginPath();
            context.rect(rect.x, rect.y, rect.width, rect.height);
            context.strokeStyle = 'yellow'
            context.lineWidth = 2
            context.stroke();
        }

    </script>
</body>

</html>